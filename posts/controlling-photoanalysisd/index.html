<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Guy Bianco IV"><meta name=description content="Background I recently bought a new MacBook. This article gets better, I promise.
I decided to set it up fresh instead of restoring from a backup. I like to take the time to try and simplify what I&rsquo;ve got on my machine.
Naturally, I expect most applications to take a little bit to sync down settings, files, etc. All of Apple&rsquo;s stuff in particular has a lot to do and I&rsquo;m fine with that."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Controlling photoanalysisd"><meta name=twitter:description content="Background I recently bought a new MacBook. This article gets better, I promise.
I decided to set it up fresh instead of restoring from a backup. I like to take the time to try and simplify what I&rsquo;ve got on my machine.
Naturally, I expect most applications to take a little bit to sync down settings, files, etc. All of Apple&rsquo;s stuff in particular has a lot to do and I&rsquo;m fine with that."><meta property="og:title" content="Controlling photoanalysisd"><meta property="og:description" content="Background I recently bought a new MacBook. This article gets better, I promise.
I decided to set it up fresh instead of restoring from a backup. I like to take the time to try and simplify what I&rsquo;ve got on my machine.
Naturally, I expect most applications to take a little bit to sync down settings, files, etc. All of Apple&rsquo;s stuff in particular has a lot to do and I&rsquo;m fine with that."><meta property="og:type" content="article"><meta property="og:url" content="https://guy.sh/posts/controlling-photoanalysisd/"><meta property="article:published_time" content="2018-07-29T21:04:36+00:00"><meta property="article:modified_time" content="2018-07-29T21:04:36+00:00"><title>Controlling photoanalysisd · Guy Bianco IV</title><link rel=canonical href=https://guy.sh/posts/controlling-photoanalysisd/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8/normalize.min.css><link rel=stylesheet href=/css/coder.min.b79ffb503467976bb5db1a55f11d2db1d230f6a68dc7aa55cf08be4f048cb1b8.css integrity="sha256-t5/7UDRnl2u12xpV8R0tsdIw9qaNx6pVzwi+TwSMsbg=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.79.1"></head><body class=colorscheme-dark><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Guy Bianco IV</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://github.com/gjbianco/>Code</a></li><li class=navigation-item><a class=navigation-link href=https://photo.guy.sh>Photos</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Controlling photoanalysisd</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2018-07-29T21:04:36Z>July 29, 2018</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>6-minute read</span></div></div></header><div><h2 id=background>Background</h2><p>I recently bought a new MacBook. This article gets better, I promise.</p><p>I decided to set it up fresh instead of restoring from a backup. I like to take the time to try and simplify what I&rsquo;ve got on my machine.</p><p>Naturally, I expect most applications to take a little bit to sync down settings, files, etc. All of Apple&rsquo;s stuff in particular has a lot to do and I&rsquo;m fine with that. However, the one I am not so fine with is Photos.</p><p>Specifically, a process called <code>photoanalysisd</code>.</p><p>This is a background service that, as the name implies, is responsible for analyzing your photos. For the most part, it seems like it is trying to recognize people. This service is directly tied to the &ldquo;People&rdquo; tab in Photos (more on this in a moment).</p><p>The fact that this happens on your machine and <em>each</em> of your machines is a good thing! There may be some things that get sent off to Apple, but the majority of the work seems to be happening on your hardware.</p><p>What is not so good is the level of control you have around if/when/how this service is controlled. Or, in this case, how it seems to control your machine.</p><p>If you go into the People tab of Photos before it is done analyzing, you will see its progress. Even if you have a fairly beefy machine, this process takes a long time. Weeks kind of long time. The only exception seems to be if you have a photo library barely into or lower than quadruple digits.</p><p>On the surface, this shouldn&rsquo;t be an issue. The sorts of analysis its doing is probably computationally hard. It uses a good amount of resources, but doesn&rsquo;t try to fully harness the machine since it is meant to be a background process that occurs over the course of days.</p><p>The main issue seems to be that you have no control over this process. I never plan to use the People tab, yet my machine still has to painstakingly go through my entire library. I have a medium size photo library (~10k) and after a few hours on the 12" i5 MacBook, it has managed to go through almost 300 of them." Many people complain about their way more powerful iMacs taking weeks to go through libraries of similar size.</p><p>During this process, the machine is still usable, but it doesn&rsquo;t go unnoticed. It does use about 25% of the CPUs constantly. This causes the fanless machine to constantly stay pretty warm and chug on some things. Usually not enough to notice, but seems like it might cause someone to be less than impressed with their <em>brand new</em> device if they didn&rsquo;t know this was going on.</p><p>On top of that, it is almost impossible for a normal user to learn this is going on. The only mention of &ldquo;photoanalysisd&rdquo; is in Activity Monitor. This should not be the only location to learn about something that is using days of CPU time. For a feature I imagine a lot of people either don&rsquo;t want or don&rsquo;t care about having on every device with Photos.</p><p>Yet it gets worse.</p><p>There are seemingly very few ways to actually get it to stop or even pause. Supposedly, it only runs when a) the machine is plugged in and b) Photos isn&rsquo;t running. This means that people that want it to pause so they can get CPU cycles back resort to running off battery unnecessarily or leaving Photos open for no reason. Even leaving Photos <em>minimized</em> makes it start up again. However, mine still runs even with Photos focused, so I guess it doesn&rsquo;t really matter.</p><p>You can also just let it finish, but this takes quite a long time (well after their 14 day return policy is up). It also seems like it gets stuck for some people, never finishing.</p><p>You can use launchctl to disable and kill the service. However, this is only a temporary reprieve (under an hour), as the OS will restart the service automatically for you. How nice.</p><p>You might be able to (re)move the service file, but that may or may not affect system stability. Not something I really want to try, personally. YMMV.</p><p>After all that, we&rsquo;re finally to my workaround&mldr;</p><h2 id=kill-it-with-fire-repeatedly>Kill It With Fire. Repeatedly.</h2><p>The family of operating systems that macOS belongs to usually come with an awesome little tool. This tool, called cron, lets you run commands in the background automatically.</p><p>Each of these commands, a cron job, can be configured to run on an interval. For example, you could have it run a command to download a particular file every day at 6am. Maybe you want a cron job to delete your internet history on the first day in June. Sure, it can do that, too. How about make you some coffee every 20 minutes? I feel like cron is not the hard part, but sure, why not.</p><p>Maybe you want it to kill a pesky background service literally every chance it gets (hint: this is exactly what we want to do).</p><p>We&rsquo;re going to make a cron job that kills the photoanalysisd service every minute. The command takes less than 10ms to run and doesn&rsquo;t error out if the service is already dead.</p><p>We do this every minute because a) I don&rsquo;t know exactly how long before the service starts again, b) even if we knew, having them get out of sync would allow photoanalysisd to run longer, and c) cron can only go down to minute granularity (I would&rsquo;ve done it every 20 seconds or so).</p><p>This does mean that photoanalysisd does potentially get ~59 seconds to run. However, assuming that it gets started exactly X minutes after getting shut off, it probably won&rsquo;t get to run very long.</p><p>Okay, here&rsquo;s how to actually do it.</p><h2 id=sudo-avada-kedavra>sudo avada kedavra</h2><p>First, you&rsquo;ll need to grab your user&rsquo;s UID to pass to launchctl:</p><p><code>echo $UID</code></p><p>The launchctl tool requires root privileges (it controls system services). This means that our cron job needs to be for the root user.</p><p>Edit the crontab for root:</p><p><code>EDITOR=nano sudo crontab -e</code></p><p>Add this line to the file:</p><p><code>*/1 * * * * launchctl disable gui/&lt;UID>/com.apple.photoanalysisd && launchctl kill -TERM gui/&lt;UID>/com.apple.photoanalysisd</code></p><p>Replacing with your user&rsquo;s UID. For example, if your UID was 123, you&rsquo;d add:</p><p><code>*/1 * * * * launchctl disable gui/123/com.apple.photoanalysisd && launchctl kill -TERM gui/123/com.apple.photoanalysisd</code></p><p>Now save the file with ^o (Control + o) and then Enter.</p><p>Close the editor with ^x (Control + x).</p><h2 id=closing-thoughts>Closing Thoughts</h2><p>First off, if anybody from the Photos team somehow ends up reading this, I&rsquo;m begging you to give us an off switch for the People tab. I don&rsquo;t use it, I don&rsquo;t plan to use it, and it is a huge waste of resources.</p><p>Second, this method is about as crude as it gets. It would be like using a pump and some garden hose to refill your gas back into your leaking tank. However, it does allow me to use my machine in peace.</p><p>Maybe someday I&rsquo;ll improve this method. Possibly using launchd, itself.</p><p>I hope I never get the chance.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2021
Guy Bianco IV</section></footer></main><script src=/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script></body></html>